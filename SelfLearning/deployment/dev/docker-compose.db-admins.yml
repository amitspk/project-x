version: '3.8'

services:
  mongo-express:
    image: mongo-express:latest
    container_name: fyi-widget-mongo-express
    restart: unless-stopped
    ports:
      - "127.0.0.1:8081:8081"  # Access UI via http://localhost:8081
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGODB_USERNAME}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGODB_PASSWORD}
      ME_CONFIG_MONGODB_URL: mongodb://${MONGODB_USERNAME}:${MONGODB_PASSWORD}@fyi-widget-mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: ${DB_UI_USER:-admin}
      ME_CONFIG_BASICAUTH_PASSWORD: ${DB_UI_PASSWORD:-change_me}
    depends_on:
      - wait-mongo
    networks:
      - fyi-widget-network

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: fyi-widget-pgadmin
    restart: unless-stopped
    ports:
      - "127.0.0.1:5050:80"   # Access UI via http://localhost:5050
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@admin.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-change_me}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - wait-postgres
    networks:
      - fyi-widget-network

  # Tiny helper containers to wait for DB health before starting UIs
  wait-mongo:
    image: bash:5.2
    container_name: fyi-widget-wait-mongo
    command: ["bash", "-lc", "for i in {1..60}; do nc -z fyi-widget-mongodb 27017 && exit 0; sleep 1; done; exit 1"]
    networks:
      - fyi-widget-network
    restart: "no"

  wait-postgres:
    image: bash:5.2
    container_name: fyi-widget-wait-postgres
    command: ["bash", "-lc", "for i in {1..60}; do nc -z fyi-widget-postgres 5432 && exit 0; sleep 1; done; exit 1"]
    networks:
      - fyi-widget-network
    restart: "no"

networks:
  fyi-widget-network:
    external: true

volumes:
  pgadmin_data:

